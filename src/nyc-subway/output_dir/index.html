<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='read' hidden></marimo-mode>
    <marimo-version data-version='0.12.8' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"theme": "light", "code_editor_font_size": 14, "cell_output": "above", "default_width": "medium", "dataframes": "rich"}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "reactive_tests": true, "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "pip"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "medium", "app_title": "Declarative Data Processing", "layout_file": "data:application/json;base64,ewogICJ0eXBlIjogImdyaWQiLAogICJkYXRhIjogewogICAgImNvbHVtbnMiOiAyNCwKICAgICJyb3dIZWlnaHQiOiAyMCwKICAgICJtYXhXaWR0aCI6IDE0MDAsCiAgICAiYm9yZGVyZWQiOiB0cnVlLAogICAgImNlbGxzIjogWwogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogWwogICAgICAgICAgNSwKICAgICAgICAgIDQ0LAogICAgICAgICAgMTQsCiAgICAgICAgICAyNQogICAgICAgIF0KICAgICAgfSwKICAgICAgewogICAgICAgICJwb3NpdGlvbiI6IFsKICAgICAgICAgIDUsCiAgICAgICAgICAxNCwKICAgICAgICAgIDE0LAogICAgICAgICAgMjUKICAgICAgICBdCiAgICAgIH0KICAgIF0KICB9Cn0=", "auto_download": ["html"], "sql_output": "auto"}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>Declarative Data Processing</title>
    <script type="module" crossorigin src="./assets/index-CGFEuydC.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-C9FDJL8i.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.12.8%22%0Aapp%20%3D%20marimo.App(%0A%20%20%20%20width%3D%22medium%22%2C%0A%20%20%20%20app_title%3D%22Declarative%20Data%20Processing%22%2C%0A%20%20%20%20layout_file%3D%22data%3Aapplication%2Fjson%3Bbase64%2CewogICJ0eXBlIjogImdyaWQiLAogICJkYXRhIjogewogICAgImNvbHVtbnMiOiAyNCwKICAgICJyb3dIZWlnaHQiOiAyMCwKICAgICJtYXhXaWR0aCI6IDE0MDAsCiAgICAiYm9yZGVyZWQiOiB0cnVlLAogICAgImNlbGxzIjogWwogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogbnVsbAogICAgICB9LAogICAgICB7CiAgICAgICAgInBvc2l0aW9uIjogWwogICAgICAgICAgNSwKICAgICAgICAgIDQ0LAogICAgICAgICAgMTQsCiAgICAgICAgICAyNQogICAgICAgIF0KICAgICAgfSwKICAgICAgewogICAgICAgICJwb3NpdGlvbiI6IFsKICAgICAgICAgIDUsCiAgICAgICAgICAxNCwKICAgICAgICAgIDE0LAogICAgICAgICAgMjUKICAgICAgICBdCiAgICAgIH0KICAgIF0KICB9Cn0%3D%22%2C%0A%20%20%20%20auto_download%3D%5B%22html%22%5D%2C%0A)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20os%0A%0A%20%20%20%20RAW_BASE_PATH%20%3D%20os.getenv(%22RAW_BASE_PATH%22%2C%20%22%2Fdata%2Fraw%22)%0A%20%20%20%20BRONZE_PATH%20%3D%20%22%2Fdelta%2Fmta_bronze%22%0A%20%20%20%20SILVER_PATH%20%3D%20%22%2Fdelta%2Fmta_silver%22%0A%20%20%20%20return%20BRONZE_PATH%2C%20RAW_BASE_PATH%2C%20SILVER_PATH%2C%20os%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20pyspark.sql%20import%20SparkSession%0A%0A%20%20%20%20spark%20%3D%20(%0A%20%20%20%20%20%20%20%20SparkSession.builder%0A%20%20%20%20%20%20%20%20.appName(%22mta-marimo%22)%0A%20%20%20%20%20%20%20%20.config(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22spark.jars.packages%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22io.delta%3Adelta-spark_2.12%3A3.1.0%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.config(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22spark.sql.extensions%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22io.delta.sql.DeltaSparkSessionExtension%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.config(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22spark.sql.catalog.spark_catalog%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%22org.apache.spark.sql.delta.catalog.DeltaCatalog%22%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20.config(%22spark.sql.shuffle.partitions%22%2C%20%224%22)%0A%20%20%20%20%20%20%20%20.config(%22spark.ui.showConsoleProgress%22%2C%20%22false%22)%0A%20%20%20%20%20%20%20%20.getOrCreate()%0A%20%20%20%20)%0A%20%20%20%20return%20SparkSession%2C%20spark%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20from%20functools%20import%20wraps%0A%20%20%20%20from%20pyspark.sql%20import%20functions%20as%20F%0A%0A%20%20%20%20def%20table(name%2C%20partition_cols%3DNone%2C%20path%3DNone%2C%20mode%3D%22overwrite%22%2C%20merge_schema%3DTrue)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Local%20%40table%20decorator%20for%20writing%20a%20DataFrame%20to%20Delta.%0A%0A%20%20%20%20%20%20%20%20This%20decorator%20wraps%20a%20function%20that%20returns%20a%20Spark%20DataFrame%2C%20and%20automatically%0A%20%20%20%20%20%20%20%20writes%20the%20DataFrame%20to%20a%20Delta%20table%20at%20the%20specified%20path.%20It%20also%20supports%20%0A%20%20%20%20%20%20%20%20partitioning%20and%20optional%20schema%20evolution.%0A%0A%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20-%20name%3A%20str%0A%20%20%20%20%20%20%20%20%20%20%20%20Logical%20name%20of%20the%20table.%20Used%20for%20default%20path%20if%20%60path%60%20is%20not%20provided.%0A%20%20%20%20%20%20%20%20-%20partition_cols%3A%20Optional%5Blist%5Bstr%5D%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20List%20of%20columns%20to%20partition%20the%20Delta%20table%20by.%20Default%20is%20None%20(no%20partitioning).%0A%20%20%20%20%20%20%20%20-%20path%3A%20Optional%5Bstr%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Path%20where%20the%20Delta%20table%20will%20be%20saved.%20Defaults%20to%20%22.%2F%7Bname%7D%22%20if%20not%20provided.%0A%20%20%20%20%20%20%20%20-%20mode%3A%20str%0A%20%20%20%20%20%20%20%20%20%20%20%20Write%20mode%20for%20the%20table.%20Typical%20values%3A%20%22overwrite%22%2C%20%22append%22.%20Default%20is%20%22overwrite%22.%0A%20%20%20%20%20%20%20%20-%20merge_schema%3A%20bool%0A%20%20%20%20%20%20%20%20%20%20%20%20Whether%20to%20enable%20Delta%20schema%20evolution%20(merge%20new%20columns%20into%20existing%20table).%20Default%20is%20True.%0A%0A%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20Decorator%20that%20writes%20the%20returned%20DataFrame%20to%20Delta%20and%20returns%20the%20original%20DataFrame.%0A%0A%20%20%20%20%20%20%20%20Usage%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Example%201%3A%20Basic%20usage%0A%20%20%20%20%20%20%20%20%20%20%20%20%40table(name%3D%22mta_bronze%22%2C%20path%3D%22.%2Fdelta%2Fmta_bronze%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20bronze()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20spark.read.option(%22recursiveFileLookup%22%2C%20%22true%22).json(RAW_BASE_PATH)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20bronze_df%20%3D%20bronze()%20%20%23%20writes%20Delta%20table%20and%20returns%20DataFrame%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Example%202%3A%20With%20partitioning%20and%20custom%20mode%0A%20%20%20%20%20%20%20%20%20%20%20%20%40table(name%3D%22orders_silver%22%2C%20path%3D%22.%2Fdelta%2Forders_silver%22%2C%20partition_cols%3D%5B%22year%22%2C%20%22month%22%5D%2C%20mode%3D%22append%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20orders_silver()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20spark.read.table(%22bronze_view%22).filter(%22topic%20%3D%20'orders'%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20orders_silver_df%20%3D%20orders_silver()%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20Example%203%3A%20Disable%20schema%20merge%20if%20not%20needed%0A%20%20%20%20%20%20%20%20%20%20%20%20%40table(name%3D%22mta_bronze_no_merge%22%2C%20path%3D%22.%2Fdelta%2Fmta_bronze%22%2C%20merge_schema%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20bronze_no_merge()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20spark.read.json(RAW_BASE_PATH)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20if%20partition_cols%20is%20None%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20partition_cols%20%3D%20%5B%5D%0A%0A%20%20%20%20%20%20%20%20def%20decorator(func)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40wraps(func)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20wrapper(*args%2C%20**kwargs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20func(*args%2C%20**kwargs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20write_path%20%3D%20path%20or%20f%22.%2F%7Bname%7D%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20writer%20%3D%20df.write.format(%22delta%22).mode(mode)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20partition_cols%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20writer%20%3D%20writer.partitionBy(*partition_cols)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20merge_schema%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20writer%20%3D%20writer.option(%22mergeSchema%22%2C%20%22true%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20writer.save(write_path)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Table%20'%7Bname%7D'%20written%20to%20%7Bwrite_path%7D%20(merge_schema%3D%7Bmerge_schema%7D)%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20wrapper%0A%20%20%20%20%20%20%20%20return%20decorator%0A%0A%0A%20%20%20%20def%20temporary_view(name%3DNone)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Local%20%40temporary_view%20decorator%20for%20creating%20a%20Spark%20temporary%20view%20from%20a%20DataFrame.%0A%0A%20%20%20%20%20%20%20%20This%20decorator%20wraps%20a%20function%20that%20returns%20a%20Spark%20DataFrame%2C%20and%20automatically%20%0A%20%20%20%20%20%20%20%20registers%20the%20DataFrame%20as%20a%20temporary%20view%20in%20Spark%20SQL.%20This%20allows%20you%20to%20query%20%0A%20%20%20%20%20%20%20%20the%20DataFrame%20using%20SQL%20later%20in%20the%20session.%0A%0A%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20-%20name%3A%20Optional%5Bstr%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20The%20name%20of%20the%20temporary%20view%20to%20create.%20%0A%20%20%20%20%20%20%20%20%20%20%20%20If%20not%20provided%2C%20defaults%20to%20the%20name%20of%20the%20decorated%20function.%0A%0A%20%20%20%20%20%20%20%20Usage%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40temporary_view(name%3D%22bronze_view%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20bronze_view()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20bronze_df%0A%0A%20%20%20%20%20%20%20%20%20%20%20%20%23%20The%20view%20'bronze_view'%20can%20now%20be%20queried%20via%20spark.sql(%22SELECT%20*%20FROM%20bronze_view%22)%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20def%20decorator(func)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40wraps(func)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20wrapper(*args%2C%20**kwargs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20func(*args%2C%20**kwargs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20view_name%20%3D%20name%20or%20func.__name__%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df.createOrReplaceTempView(view_name)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Temporary%20view%20'%7Bview_name%7D'%20created%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20wrapper%0A%20%20%20%20%20%20%20%20return%20decorator%0A%0A%0A%20%20%20%20def%20expect_or_drop(expectation_name%2C%20condition)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Decorator%20to%20drop%20rows%20from%20a%20DataFrame%20that%20do%20not%20meet%20the%20specified%20condition.%0A%0A%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20-%20expectation_name%3A%20str%0A%20%20%20%20%20%20%20%20%20%20%20%20A%20descriptive%20name%20for%20the%20expectation%20(used%20in%20logs).%0A%20%20%20%20%20%20%20%20-%20condition%3A%20str%0A%20%20%20%20%20%20%20%20%20%20%20%20A%20SQL%20expression%20used%20to%20filter%20the%20DataFrame.%20Rows%20failing%20this%20condition%20are%20dropped.%0A%0A%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20Decorator%20that%20applies%20the%20expectation%20to%20a%20DataFrame-returning%20function.%0A%0A%20%20%20%20%20%20%20%20Usage%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40expect_or_drop(%22valid_quantity%22%2C%20%22quantity%20%3E%200%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20orders_silver()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20spark.read.table(%22bronze_view%22)%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20def%20decorator(func)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40wraps(func)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20wrapper(*args%2C%20**kwargs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20func(*args%2C%20**kwargs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20df.filter(condition)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Expectation%20'%7Bexpectation_name%7D'%20applied%3A%20dropped%20failing%20rows%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20wrapper%0A%20%20%20%20%20%20%20%20return%20decorator%0A%0A%0A%20%20%20%20def%20expect_all(rules%3A%20dict)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Decorator%20to%20mark%20rows%20failing%20any%20rule%20by%20adding%20an%20'is_quarantined'%20column.%0A%0A%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20-%20rules%3A%20dict%0A%20%20%20%20%20%20%20%20%20%20%20%20A%20mapping%20of%20rule%20names%20to%20SQL%20expressions.%20%0A%20%20%20%20%20%20%20%20%20%20%20%20Rows%20that%20fail%20any%20of%20these%20rules%20will%20have%20'is_quarantined'%20%3D%20True.%0A%0A%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20Decorator%20that%20adds%20the%20'is_quarantined'%20column%20to%20a%20DataFrame-returning%20function.%0A%0A%20%20%20%20%20%20%20%20Usage%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40expect_all(%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22valid_price%22%3A%20%22price%20BETWEEN%200%20AND%20100%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22valid_id%22%3A%20%22book_id%20IS%20NOT%20NULL%22%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D)%0A%20%20%20%20%20%20%20%20%20%20%20%20%40temporary_view(name%3D%22books_raw%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20books_raw()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20spark.read.table(%22bronze_view%22)%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20def%20decorator(func)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40wraps(func)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20wrapper(*args%2C%20**kwargs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20func(*args%2C%20**kwargs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20quarantine_expr%20%3D%20%22%20OR%20%22.join(f%22NOT(%7Bv%7D)%22%20for%20v%20in%20rules.values())%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20df.withColumn(%22is_quarantined%22%2C%20F.expr(quarantine_expr))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Expectations%20%7Blist(rules.keys())%7D%20applied%3A%20'is_quarantined'%20column%20added%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20wrapper%0A%20%20%20%20%20%20%20%20return%20decorator%0A%0A%0A%20%20%20%20def%20expect_or_fail(expectation_name%2C%20condition)%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Decorator%20that%20fails%20the%20pipeline%20if%20any%20row%20does%20not%20meet%20the%20specified%20condition.%0A%0A%20%20%20%20%20%20%20%20Parameters%3A%0A%20%20%20%20%20%20%20%20-%20expectation_name%3A%20str%0A%20%20%20%20%20%20%20%20%20%20%20%20A%20descriptive%20name%20for%20the%20expectation%20(used%20in%20logs).%0A%20%20%20%20%20%20%20%20-%20condition%3A%20str%0A%20%20%20%20%20%20%20%20%20%20%20%20A%20SQL%20expression%20used%20to%20check%20each%20row.%20Pipeline%20fails%20if%20any%20row%20violates%20it.%0A%0A%20%20%20%20%20%20%20%20Returns%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20Decorator%20that%20enforces%20the%20expectation%20strictly.%0A%0A%20%20%20%20%20%20%20%20Usage%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40expect_or_fail(%22positive_total%22%2C%20%22total%20%3E%200%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%40table(name%3D%22critical_orders%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20critical_orders()%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20spark.read.table(%22bronze_view%22)%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20def%20decorator(func)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%40wraps(func)%0A%20%20%20%20%20%20%20%20%20%20%20%20def%20wrapper(*args%2C%20**kwargs)%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20df%20%3D%20func(*args%2C%20**kwargs)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20failing_count%20%3D%20df.filter(f%22NOT(%7Bcondition%7D)%22).count()%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20if%20failing_count%20%3E%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20raise%20ValueError(f%22Expectation%20'%7Bexpectation_name%7D'%20failed%3A%20%7Bfailing_count%7D%20rows%20do%20not%20meet%20the%20condition%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20print(f%22Expectation%20'%7Bexpectation_name%7D'%20passed%3A%20all%20rows%20meet%20the%20condition%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20return%20df%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20wrapper%0A%20%20%20%20%20%20%20%20return%20decorator%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20F%2C%0A%20%20%20%20%20%20%20%20expect_all%2C%0A%20%20%20%20%20%20%20%20expect_or_drop%2C%0A%20%20%20%20%20%20%20%20expect_or_fail%2C%0A%20%20%20%20%20%20%20%20table%2C%0A%20%20%20%20%20%20%20%20temporary_view%2C%0A%20%20%20%20%20%20%20%20wraps%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(BRONZE_PATH%2C%20F%2C%20RAW_BASE_PATH%2C%20spark%2C%20table)%3A%0A%20%20%20%20%40table(%0A%20%20%20%20%20%20%20%20name%3D%22mta_bronze%22%2C%0A%20%20%20%20%20%20%20%20partition_cols%3D%5B%5D%2C%0A%20%20%20%20%20%20%20%20path%3DBRONZE_PATH%2C%0A%20%20%20%20%20%20%20%20mode%3D%22overwrite%22%0A%20%20%20%20)%0A%20%20%20%20def%20bronze()%3A%0A%20%20%20%20%20%20%20%20df%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20spark.read%0A%20%20%20%20%20%20%20%20%20%20%20%20.option(%22recursiveFileLookup%22%2C%20%22true%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.json(RAW_BASE_PATH)%0A%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20df%20%3D%20df.withColumn(%22ingest_ts%22%2C%20F.current_timestamp())%0A%20%20%20%20%20%20%20%20return%20df%0A%0A%20%20%20%20%23%20Run%20the%20bronze%20pipeline%0A%20%20%20%20bronze_df%20%3D%20bronze()%0A%20%20%20%20return%20bronze%2C%20bronze_df%0A%0A%0A%40app.cell%0Adef%20_(BRONZE_PATH%2C%20spark%2C%20temporary_view)%3A%0A%20%20%20%20%40temporary_view(name%3D%22bronze_view%22)%0A%20%20%20%20def%20bronze_view()%3A%0A%20%20%20%20%20%20%20%20df%20%3D%20spark.read.format(%22delta%22).load(BRONZE_PATH)%0A%20%20%20%20%20%20%20%20return%20df%0A%0A%20%20%20%20%23%20Create%20the%20temp%20view%0A%20%20%20%20tmp_v%20%3D%20bronze_view()%0A%0A%20%20%20%20_pdf%20%3D%20tmp_v.limit(1000).toPandas()%0A%20%20%20%20_pdf%0A%20%20%20%20return%20bronze_view%2C%20tmp_v%0A%0A%0A%40app.cell%0Adef%20_(BRONZE_PATH%2C%20F%2C%20expect_or_drop%2C%20spark%2C%20temporary_view)%3A%0A%20%20%20%20%40temporary_view(name%3D%22silver_view%22)%0A%20%20%20%20%40expect_or_drop(%22assigned_trains_only%22%2C%20%22is_assigned%20%3D%20True%22)%0A%20%20%20%20def%20silver_view()%3A%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20Reads%20bronze%20Delta%20table%2C%20drops%20rows%20with%20missing%20actual_track%20or%20non-assigned%20trains%2C%0A%20%20%20%20%20%20%20%20and%20returns%20a%20cleaned%20DataFrame%20ready%20for%20silver%20layer.%0A%20%20%20%20%20%20%20%20%22%22%22%0A%20%20%20%20%20%20%20%20df%20%3D%20spark.read.format(%22delta%22).load(BRONZE_PATH)%0A%20%20%20%20%20%20%20%20df%20%3D%20df.withColumn(%22silver_ingest_ts%22%2C%20F.current_timestamp())%0A%20%20%20%20%20%20%20%20return%20df%0A%0A%0A%20%20%20%20_tmp_v%20%3D%20silver_view()%20%20%0A%0A%20%20%20%20_silver_pdf%20%3D%20_tmp_v.limit(1000).toPandas()%0A%20%20%20%20_silver_pdf%0A%20%20%20%20return%20(silver_view%2C)%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>

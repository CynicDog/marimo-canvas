<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="./favicon.ico" />
    <!-- Preload is necessary because we show these images when we disconnect from the server,
    but at that point we cannot load these images from the server -->
    <link rel="preload" href="./assets/gradient-yHQUC_QB.png" as="image" />
    <link rel="preload" href="./assets/noise-60BoTA8O.png" as="image" />
    <!-- Preload the fonts -->
    <link rel="preload" href="./assets/Lora-VariableFont_wght-B2ootaw-.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Regular-CxL0S8W7.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/PTSans-Bold-D9fedIX3.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Regular-BTCkDNvf.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Medium-DU3aDxX5.ttf" as="font" crossorigin="anonymous" />
    <link rel="preload" href="./assets/FiraMono-Bold-CLVRCuM9.ttf" as="font" crossorigin="anonymous" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta name="description" content="a marimo app" />
    <link rel="apple-touch-icon" href="./apple-touch-icon.png" />
    <link rel="manifest" href="./manifest.json" />

    <script data-marimo="true">
      function __resizeIframe(obj) {
        var scrollbarHeight = 20; // Max between windows, mac, and linux

        function setHeight() {
          var element = obj.contentWindow.document.documentElement;
          // If there is no vertical scrollbar, we don't need to resize the iframe
          if (element.scrollHeight === element.clientHeight) {
            return;
          }

          // Create a new height that includes the scrollbar height if it's visible
          var hasHorizontalScrollbar = element.scrollWidth > element.clientWidth;
          var newHeight = element.scrollHeight + (hasHorizontalScrollbar ? scrollbarHeight : 0);

          // Only update the height if it's different from the current height
          if (obj.style.height !== `${newHeight}px`) {
            obj.style.height = `${newHeight}px`;
          }
        }

        // Resize the iframe to the height of the content and bottom scrollbar height
        setHeight();

        // Resize the iframe when the content changes
        const resizeObserver = new ResizeObserver((entries) => {
          setHeight();
        });
        resizeObserver.observe(obj.contentWindow.document.body);
      }
    </script>
    <marimo-filename hidden>notebook.py</marimo-filename>
    <marimo-mode data-mode='read' hidden></marimo-mode>
    <marimo-version data-version='0.12.8' hidden></marimo-version>
    <marimo-user-config data-config='{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"theme": "light", "code_editor_font_size": 14, "cell_output": "above", "default_width": "medium", "dataframes": "rich"}, "formatting": {"line_length": 79}, "keymap": {"preset": "default", "overrides": {}}, "runtime": {"auto_instantiate": true, "auto_reload": "off", "reactive_tests": true, "on_cell_change": "autorun", "watcher_on_save": "lazy", "output_max_bytes": 8000000, "std_stream_max_bytes": 1000000}, "save": {"autosave": "off", "autosave_delay": 1000, "format_on_save": false}, "package_management": {"manager": "pip"}, "server": {"browser": "default", "follow_symlink": false}, "language_servers": {"pylsp": {"enabled": true, "enable_mypy": true, "enable_ruff": true, "enable_flake8": false, "enable_pydocstyle": false, "enable_pylint": false, "enable_pyflakes": false}}, "snippets": {"custom_paths": [], "include_default_snippets": true}}' data-overrides='{}' hidden></marimo-user-config>
    <marimo-app-config data-config='{"width": "medium", "sql_output": "auto"}' hidden></marimo-app-config>
    <marimo-server-token data-token='123' hidden></marimo-server-token>
    <title>dashboard</title>
    <script type="module" crossorigin src="./assets/index-CGFEuydC.js"></script>
    <link rel="stylesheet" crossorigin href="./assets/index-C9FDJL8i.css">
  <marimo-wasm hidden=""></marimo-wasm>
    <script>
        if (window.location.protocol === 'file:') {
            alert('Warning: This file must be served by an HTTP server to function correctly.');
        }
    </script>
    
    <style>
        #save-button {
            display: none !important;
        }
        #filename-input {
            display: none !important;
        }
    </style>
    <marimo-code hidden="" data-show-code="false">import%20marimo%0A%0A__generated_with%20%3D%20%220.12.8%22%0Aapp%20%3D%20marimo.App(width%3D%22medium%22)%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20%23%20docker%20cp%20data%2Fnyc-subway%2Fgtfs_supplemented%20silly_maxwell%3A%2Fapp%2Fdata%2Fgtfs_supplemented%0A%20%20%20%20%23%20docker%20exec%20-u%20root%20silly_maxwell%20chmod%20-R%20755%20%2Fapp%0A%20%20%20%20return%0A%0A%0A%40app.cell%0Adef%20_()%3A%0A%20%20%20%20import%20pandas%20as%20pd%0A%20%20%20%20import%20altair%20as%20alt%0A%20%20%20%20import%20marimo%20as%20mo%0A%20%20%20%20import%20os%0A%20%20%20%20return%20alt%2C%20mo%2C%20os%2C%20pd%0A%0A%0A%40app.cell%0Adef%20_(alt%2C%20full_stop_times)%3A%0A%20%20%20%20def%20get_eda_summary(selected_routes)%3A%0A%20%20%20%20%20%20%20%20%23%20Filter%20data%20based%20on%20selected%20subway%20routes%0A%20%20%20%20%20%20%20%20filtered_st%20%3D%20full_stop_times%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20full_stop_times%5B%22route_id%22%5D.isin(selected_routes)%0A%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20%23%20Summary%20Table%20(route-level)%0A%20%20%20%20%20%20%20%20summary%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20filtered_st%0A%20%20%20%20%20%20%20%20%20%20%20%20.groupby(%22route_id%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.agg(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20total_arrivals%3D(%22trip_id%22%2C%20%22count%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20unique_stops%3D(%22stop_id%22%2C%20%22nunique%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20directions%3D(%22direction_id%22%2C%20%22nunique%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.reset_index()%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Hourly%20Trend%20Chart%0A%20%20%20%20%20%20%20%20hourly_trend%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20filtered_st%0A%20%20%20%20%20%20%20%20%20%20%20%20.groupby(%5B%22hour%22%2C%20%22route_id%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.size()%0A%20%20%20%20%20%20%20%20%20%20%20%20.reset_index(name%3D%22arrivals%22)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20trend_chart%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(hourly_trend)%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_line(interpolate%3D%22basis%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%22hour%3AQ%22%2C%20title%3D%22Hour%20of%20Day%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%22arrivals%3AQ%22%2C%20title%3D%22Scheduled%20Arrivals%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%22route_id%3AN%22%2C%20title%3D%22Subway%20Route%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%22hour%22%2C%20%22route_id%22%2C%20%22arrivals%22%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.properties(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20height%3D200%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20title%3D%22System-Wide%20Hourly%20Subway%20Pulse%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20summary%2C%20trend_chart%0A%20%20%20%20return%20(get_eda_summary%2C)%0A%0A%0A%40app.cell%0Adef%20_(mo%2C%20os%2C%20pd)%3A%0A%20%20%20%20GTFS_PATH%20%3D%20os.path.join(%22data%22%2C%20%22gtfs_supplemented%22)%0A%0A%20%20%20%20%40mo.cache%0A%20%20%20%20def%20load_and_preprocess()%3A%0A%20%20%20%20%20%20%20%20%22%22%22Load%20MTA%20Subway%20GTFS%20snapshot%20for%20EDA%20and%20mapping%22%22%22%0A%0A%20%20%20%20%20%20%20%20%23%20Stops%0A%20%20%20%20%20%20%20%20stops%20%3D%20pd.read_csv(%0A%20%20%20%20%20%20%20%20%20%20%20%20os.path.join(GTFS_PATH%2C%20%22stops.txt%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20usecols%3D%5B%22stop_id%22%2C%20%22stop_name%22%2C%20%22stop_lat%22%2C%20%22stop_lon%22%2C%20%22parent_station%22%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Stop%20times%0A%20%20%20%20%20%20%20%20stop_times%20%3D%20pd.read_csv(%0A%20%20%20%20%20%20%20%20%20%20%20%20os.path.join(GTFS_PATH%2C%20%22stop_times.txt%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20usecols%3D%5B%22trip_id%22%2C%20%22stop_id%22%2C%20%22arrival_time%22%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Trips%0A%20%20%20%20%20%20%20%20trips%20%3D%20pd.read_csv(%0A%20%20%20%20%20%20%20%20%20%20%20%20os.path.join(GTFS_PATH%2C%20%22trips.txt%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20usecols%3D%5B%22trip_id%22%2C%20%22route_id%22%2C%20%22direction_id%22%2C%20%22shape_id%22%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Routes%20(THIS%20WAS%20MISSING)%0A%20%20%20%20%20%20%20%20routes%20%3D%20pd.read_csv(%0A%20%20%20%20%20%20%20%20%20%20%20%20os.path.join(GTFS_PATH%2C%20%22routes.txt%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20usecols%3D%5B%22route_id%22%2C%20%22route_color%22%2C%20%22route_short_name%22%5D%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Normalize%20route_color%20(ensure%20leading%20%23)%0A%20%20%20%20%20%20%20%20routes%5B%22route_color%22%5D%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20%22%23%22%20%2B%20routes%5B%22route_color%22%5D.str.strip()%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Merge%20stop_times%20%E2%86%94%20trips%0A%20%20%20%20%20%20%20%20stop_times%20%3D%20stop_times.merge(trips%2C%20on%3D%22trip_id%22%2C%20how%3D%22left%22)%0A%0A%20%20%20%20%20%20%20%20%23%20Merge%20routes%20to%20inject%20route_color%0A%20%20%20%20%20%20%20%20stop_times%20%3D%20stop_times.merge(%0A%20%20%20%20%20%20%20%20%20%20%20%20routes%5B%5B%22route_id%22%2C%20%22route_color%22%5D%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22route_id%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%20Extract%20hour%20(00%E2%80%9323)%0A%20%20%20%20%20%20%20%20stop_times%5B%22hour%22%5D%20%3D%20stop_times%5B%22arrival_time%22%5D.str.slice(0%2C%202).astype(int)%0A%0A%20%20%20%20%20%20%20%20return%20stops%2C%20stop_times%2C%20routes%0A%0A%0A%20%20%20%20full_stops%2C%20full_stop_times%2C%20routes%20%3D%20load_and_preprocess()%0A%20%20%20%20return%20GTFS_PATH%2C%20full_stop_times%2C%20full_stops%2C%20load_and_preprocess%2C%20routes%0A%0A%0A%40app.cell%0Adef%20_(full_stop_times%2C%20mo)%3A%0A%20%20%20%20%23%20Hour%20selector%0A%20%20%20%20hour_options%20%3D%20%7B%0A%20%20%20%20%20%20%20%20f%22%7Bh%3A02d%7D%3A00%20-%20%7B(h%20%2B%201)%3A02d%7D%3A00%22%3A%20h%0A%20%20%20%20%20%20%20%20for%20h%20in%20range(24)%0A%20%20%20%20%7D%0A%0A%20%20%20%20time_dropdown%20%3D%20mo.ui.dropdown(%0A%20%20%20%20%20%20%20%20options%3Dhour_options%2C%0A%20%20%20%20%20%20%20%20value%3D%2208%3A00%20-%2009%3A00%22%2C%0A%20%20%20%20%20%20%20%20label%3D%22Select%20Hour%22%0A%20%20%20%20)%0A%0A%20%20%20%20%23%20Route%20selector%20(derived%20from%20GTFS)%0A%20%20%20%20route_ids%20%3D%20sorted(full_stop_times%5B%22route_id%22%5D.dropna().unique())%0A%0A%20%20%20%20route_selector%20%3D%20mo.ui.multiselect(%0A%20%20%20%20%20%20%20%20options%3Droute_ids%2C%0A%20%20%20%20%20%20%20%20value%3Droute_ids%2C%0A%20%20%20%20%20%20%20%20label%3D%22Include%20Subway%20Routes%22%0A%20%20%20%20)%0A%20%20%20%20return%20hour_options%2C%20route_ids%2C%20route_selector%2C%20time_dropdown%0A%0A%0A%40app.cell%0Adef%20_(alt%2C%20full_stop_times%2C%20full_stops%2C%20mo)%3A%0A%20%20%20%20def%20get_city_map(selected_hour%2C%20selected_routes)%3A%0A%20%20%20%20%20%20%20%20%23%201.%20Guard%20clauses%0A%20%20%20%20%20%20%20%20if%20not%20selected_routes%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20mo.md(%22%23%23%23%20Select%20at%20least%20one%20subway%20route%20to%20view%20the%20map.%22)%0A%0A%20%20%20%20%20%20%20%20h_data%20%3D%20full_stop_times%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(full_stop_times%5B%22hour%22%5D%20%3D%3D%20selected_hour)%0A%20%20%20%20%20%20%20%20%20%20%20%20%26%20(full_stop_times%5B%22route_id%22%5D.isin(selected_routes))%0A%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20if%20h_data.empty%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%20mo.md(f%22%23%23%23%20No%20subway%20arrivals%20found%20for%20%7Bselected_hour%3A02d%7D%3A00.%22)%0A%0A%20%20%20%20%20%20%20%20%23%202.%20Aggregate%20stop-level%20activity%0A%20%20%20%20%20%20%20%20counts%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20h_data%0A%20%20%20%20%20%20%20%20%20%20%20%20.groupby(%5B%22stop_id%22%2C%20%22route_id%22%2C%20%22route_color%22%5D)%0A%20%20%20%20%20%20%20%20%20%20%20%20.size()%0A%20%20%20%20%20%20%20%20%20%20%20%20.reset_index(name%3D%22stop_count%22)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20map_data%20%3D%20counts.merge(%0A%20%20%20%20%20%20%20%20%20%20%20%20full_stops%5B%5B%22stop_id%22%2C%20%22stop_name%22%2C%20%22stop_lat%22%2C%20%22stop_lon%22%5D%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22stop_id%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20%23%203.%20Build%20map%20chart%20using%20GTFS%20route_color%0A%20%20%20%20%20%20%20%20chart%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20alt.Chart(map_data.sample(min(len(map_data)%2C%2012000)))%0A%20%20%20%20%20%20%20%20%20%20%20%20.mark_circle(opacity%3D0.35%2C%20stroke%3D%22black%22%2C%20strokeWidth%3D0.2)%0A%20%20%20%20%20%20%20%20%20%20%20%20.encode(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20x%3Dalt.X(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22stop_lon%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3D%5B-74.26%2C%20-73.70%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20y%3Dalt.Y(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22stop_lat%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(domain%3D%5B40.49%2C%2040.92%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20axis%3DNone%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20size%3Dalt.Size(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22stop_count%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3Dalt.Scale(type%3D%22pow%22%2C%20exponent%3D2.5%2C%20range%3D%5B10%2C%202000%5D)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3Dalt.Legend(title%3D%22Scheduled%20Trains%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20color%3Dalt.Color(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22route_color%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20scale%3DNone%2C%20%20%23%20%F0%9F%91%88%20critical%3A%20disables%20Vega%20palette%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20legend%3Dalt.Legend(title%3D%22Subway%20Route%22)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20tooltip%3D%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22stop_name%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22route_id%3AN%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22stop_count%3AQ%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.properties(width%3D%22container%22%2C%20height%3D800)%0A%20%20%20%20%20%20%20%20%20%20%20%20.configure_view(stroke%3DNone)%0A%20%20%20%20%20%20%20%20%20%20%20%20.interactive()%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20mo.ui.altair_chart(chart)%0A%20%20%20%20return%20(get_city_map%2C)%0A%0A%0A%40app.cell%0Adef%20_(full_stop_times%2C%20full_stops)%3A%0A%20%20%20%20def%20get_top_stops(selected_hour%2C%20selected_routes)%3A%0A%20%20%20%20%20%20%20%20h_data%20%3D%20full_stop_times%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20(full_stop_times%5B%22hour%22%5D%20%3D%3D%20selected_hour)%0A%20%20%20%20%20%20%20%20%20%20%20%20%26%20(full_stop_times%5B%22route_id%22%5D.isin(selected_routes))%0A%20%20%20%20%20%20%20%20%5D%0A%0A%20%20%20%20%20%20%20%20top_stops%20%3D%20(%0A%20%20%20%20%20%20%20%20%20%20%20%20h_data%0A%20%20%20%20%20%20%20%20%20%20%20%20.groupby(%22stop_id%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.size()%0A%20%20%20%20%20%20%20%20%20%20%20%20.reset_index(name%3D%22arrivals%22)%0A%20%20%20%20%20%20%20%20%20%20%20%20.merge(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20full_stops%5B%5B%22stop_id%22%2C%20%22stop_name%22%5D%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20on%3D%22stop_id%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20how%3D%22left%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%0A%20%20%20%20%20%20%20%20%20%20%20%20.sort_values(%22arrivals%22%2C%20ascending%3DFalse)%0A%20%20%20%20%20%20%20%20%20%20%20%20.head(10)%0A%20%20%20%20%20%20%20%20)%0A%0A%20%20%20%20%20%20%20%20return%20top_stops%0A%20%20%20%20return%20(get_top_stops%2C)%0A%0A%0A%40app.cell%0Adef%20_(get_eda_summary%2C%20mo%2C%20route_selector)%3A%0A%20%20%20%20summary_df%2C%20trend_viz%20%3D%20get_eda_summary(route_selector.value)%0A%0A%20%20%20%20selection_status%20%3D%20mo.stat(%0A%20%20%20%20%20%20%20%20label%3D%22Active%20Routes%22%2C%0A%20%20%20%20%20%20%20%20value%3D%22%2C%20%22.join(route_selector.value)%20if%20route_selector.value%20else%20%22None%22%2C%0A%20%20%20%20%20%20%20%20caption%3Df%22Analyzing%20%7Blen(route_selector.value)%7D%20subway%20routes%22%2C%0A%20%20%20%20)%0A%20%20%20%20return%20selection_status%2C%20summary_df%2C%20trend_viz%0A%0A%0A%40app.cell%0Adef%20_(full_stop_times%2C%20route_selector%2C%20time_dropdown)%3A%0A%20%20%20%20%23%201.%20Get%20data%20for%20the%20selected%20hour%20and%20the%20previous%20hour%0A%20%20%20%20current_hour%20%3D%20time_dropdown.value%0A%20%20%20%20prev_hour%20%3D%20(current_hour%20-%201)%20%25%2024%0A%0A%20%20%20%20%23%20Filter%20data%0A%20%20%20%20curr_filt%20%3D%20full_stop_times%5B%0A%20%20%20%20%20%20%20%20(full_stop_times%5B%22hour%22%5D%20%3D%3D%20current_hour)%0A%20%20%20%20%20%20%20%20%26%20(full_stop_times%5B%22route_id%22%5D.isin(route_selector.value))%0A%20%20%20%20%5D%0A%0A%20%20%20%20prev_filt%20%3D%20full_stop_times%5B%0A%20%20%20%20%20%20%20%20(full_stop_times%5B%22hour%22%5D%20%3D%3D%20prev_hour)%0A%20%20%20%20%20%20%20%20%26%20(full_stop_times%5B%22route_id%22%5D.isin(route_selector.value))%0A%20%20%20%20%5D%0A%20%20%20%20return%20curr_filt%2C%20current_hour%2C%20prev_filt%2C%20prev_hour%0A%0A%0A%40app.cell%0Adef%20_(curr_filt%2C%20prev_filt)%3A%0A%20%20%20%20%23%202.%20Calculation%20Helper%0A%20%20%20%20def%20get_rate(current%2C%20previous)%3A%0A%20%20%20%20%20%20%20%20if%20previous%20%3D%3D%200%3A%0A%20%20%20%20%20%20%20%20%20%20%20%20return%200%0A%20%20%20%20%20%20%20%20return%20(current%20-%20previous)%20%2F%20previous%0A%0A%0A%20%20%20%20%23%20Total%20Arrivals%0A%20%20%20%20curr_arrivals%20%3D%20len(curr_filt)%0A%20%20%20%20prev_arrivals%20%3D%20len(prev_filt)%0A%20%20%20%20arrival_rate%20%3D%20get_rate(curr_arrivals%2C%20prev_arrivals)%0A%0A%20%20%20%20%23%20Active%20Routes%0A%20%20%20%20curr_routes%20%3D%20curr_filt%5B%22route_id%22%5D.nunique()%0A%20%20%20%20prev_routes%20%3D%20prev_filt%5B%22route_id%22%5D.nunique()%0A%20%20%20%20route_rate%20%3D%20get_rate(curr_routes%2C%20prev_routes)%0A%0A%20%20%20%20%23%20Active%20Stops%0A%20%20%20%20curr_stops%20%3D%20curr_filt%5B%22stop_id%22%5D.nunique()%0A%20%20%20%20prev_stops%20%3D%20prev_filt%5B%22stop_id%22%5D.nunique()%0A%20%20%20%20stop_rate%20%3D%20get_rate(curr_stops%2C%20prev_stops)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20arrival_rate%2C%0A%20%20%20%20%20%20%20%20curr_arrivals%2C%0A%20%20%20%20%20%20%20%20curr_routes%2C%0A%20%20%20%20%20%20%20%20curr_stops%2C%0A%20%20%20%20%20%20%20%20get_rate%2C%0A%20%20%20%20%20%20%20%20prev_arrivals%2C%0A%20%20%20%20%20%20%20%20prev_routes%2C%0A%20%20%20%20%20%20%20%20prev_stops%2C%0A%20%20%20%20%20%20%20%20route_rate%2C%0A%20%20%20%20%20%20%20%20stop_rate%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20arrival_rate%2C%0A%20%20%20%20curr_arrivals%2C%0A%20%20%20%20curr_routes%2C%0A%20%20%20%20curr_stops%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20route_rate%2C%0A%20%20%20%20stop_rate%2C%0A)%3A%0A%20%20%20%20%23%203.%20Create%20Stat%20Widgets%0A%20%20%20%20total_arrivals_stat%20%3D%20mo.stat(%0A%20%20%20%20%20%20%20%20label%3D%22Total%20Arrivals%22%2C%0A%20%20%20%20%20%20%20%20bordered%3DTrue%2C%0A%20%20%20%20%20%20%20%20caption%3Df%22%7Barrival_rate%3A%2B.0%25%7D%20vs%20last%20hour%22%2C%0A%20%20%20%20%20%20%20%20direction%3D%22increase%22%20if%20arrival_rate%20%3E%3D%200%20else%20%22decrease%22%2C%0A%20%20%20%20%20%20%20%20value%3Df%22%7Bcurr_arrivals%3A%2C%7D%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20active_routes_stat%20%3D%20mo.stat(%0A%20%20%20%20%20%20%20%20label%3D%22Active%20Routes%22%2C%0A%20%20%20%20%20%20%20%20bordered%3DTrue%2C%0A%20%20%20%20%20%20%20%20caption%3Df%22%7Broute_rate%3A%2B.0%25%7D%22%2C%0A%20%20%20%20%20%20%20%20direction%3D%22increase%22%20if%20route_rate%20%3E%3D%200%20else%20%22decrease%22%2C%0A%20%20%20%20%20%20%20%20value%3Dstr(curr_routes)%2C%0A%20%20%20%20)%0A%0A%20%20%20%20active_stops_stat%20%3D%20mo.stat(%0A%20%20%20%20%20%20%20%20label%3D%22Active%20Stops%22%2C%0A%20%20%20%20%20%20%20%20bordered%3DTrue%2C%0A%20%20%20%20%20%20%20%20caption%3Df%22%7Bstop_rate%3A%2B.0%25%7D%22%2C%0A%20%20%20%20%20%20%20%20direction%3D%22increase%22%20if%20stop_rate%20%3E%3D%200%20else%20%22decrease%22%2C%0A%20%20%20%20%20%20%20%20value%3Df%22%7Bcurr_stops%3A%2C%7D%22%2C%0A%20%20%20%20)%0A%0A%20%20%20%20stats_row%20%3D%20mo.hstack(%0A%20%20%20%20%20%20%20%20%5Btotal_arrivals_stat%2C%20active_routes_stat%2C%20active_stops_stat%5D%2C%0A%20%20%20%20%20%20%20%20widths%3D%22equal%22%2C%0A%20%20%20%20%20%20%20%20gap%3D1%2C%0A%20%20%20%20)%0A%20%20%20%20return%20(%0A%20%20%20%20%20%20%20%20active_routes_stat%2C%0A%20%20%20%20%20%20%20%20active_stops_stat%2C%0A%20%20%20%20%20%20%20%20stats_row%2C%0A%20%20%20%20%20%20%20%20total_arrivals_stat%2C%0A%20%20%20%20)%0A%0A%0A%40app.cell%0Adef%20_(%0A%20%20%20%20get_city_map%2C%0A%20%20%20%20mo%2C%0A%20%20%20%20route_selector%2C%0A%20%20%20%20stats_row%2C%0A%20%20%20%20summary_df%2C%0A%20%20%20%20time_dropdown%2C%0A%20%20%20%20trend_viz%2C%0A)%3A%0A%20%20%20%20mo.vstack(%5B%0A%20%20%20%20%20%20%20%20mo.md(%22%23%20NYC%20Subway%20Intelligence%20Dashboard%22)%2C%0A%0A%20%20%20%20%20%20%20%20%23%20Controls%0A%20%20%20%20%20%20%20%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Btime_dropdown%2C%20route_selector%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20gap%3D6%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%2C%0A%20%20%20%20%20%20%20%20)%2C%0A%0A%20%20%20%20%20%20%20%20%23%20Metrics%0A%20%20%20%20%20%20%20%20mo.md(%22%23%23%20Subway%20Metrics%22)%2C%0A%20%20%20%20%20%20%20%20stats_row%2C%0A%0A%20%20%20%20%20%20%20%20%23%20Tables%20and%20Charts%0A%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20Route%20Activity%22)%2C%0A%20%20%20%20%20%20%20%20mo.ui.table(summary_df)%2C%0A%0A%20%20%20%20%20%20%20%20mo.md(%22%23%23%23%20Hourly%20Subway%20Pulse%22)%2C%0A%20%20%20%20%20%20%20%20trend_viz%2C%0A%0A%20%20%20%20%20%20%20%20%23%20Controls%20(repeat%20for%20UX%20symmetry)%0A%20%20%20%20%20%20%20%20mo.callout(%0A%20%20%20%20%20%20%20%20%20%20%20%20mo.hstack(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%5Btime_dropdown%2C%20route_selector%5D%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20justify%3D%22center%22%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20gap%3D6%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20)%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20kind%3D%22info%22%2C%0A%20%20%20%20%20%20%20%20)%2C%0A%0A%20%20%20%20%20%20%20%20%23%20Map%20(still%20stop-based%20for%20now)%0A%20%20%20%20%20%20%20%20mo.md(%22%23%23%20Live%20Station%20Density%20Map%22)%2C%0A%20%20%20%20%20%20%20%20get_city_map(time_dropdown.value%2C%20route_selector.value)%2C%0A%20%20%20%20%5D)%0A%20%20%20%20return%0A%0A%0Aif%20__name__%20%3D%3D%20%22__main__%22%3A%0A%20%20%20%20app.run()%0A</marimo-code></head>
  <body>
    <div id="root"></div>
  </body>
</html>
